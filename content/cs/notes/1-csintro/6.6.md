---
title: 6.6 文件
---

文件系统是操作系统中负责管理持久化数据的子系统。它提供了一种抽象机制，将硬盘等物理存储设备上的数据组织成易于理解和管理的**文件**和**目录**。

## 目录树结构 (Directory Tree)

现代操作系统通常采用**树形结构**来组织文件。

- **根目录 (Root Directory)**：树的起点。在 Windows 中通常是盘符（如 `C:\`），在 Unix/Linux 中是 `/`。
- **目录 (Directory/Folder)**：可以包含文件和其他目录的容器。
- **文件 (File)**：存储数据的基本单元。
- **路径 (Path)**：定位文件的地址。
  - **绝对路径**：从根目录开始的完整路径。例如：`C:\Users\Alice\Documents\file.txt`
  - **相对路径**：相对于当前工作目录的路径。例如：`./DataAnalysis/data.csv`

**示例结构**：

```text
C:\ (Root)
├── Windows/
├── Program Files/
└── Users/
    └── Alice/
        ├── Documents/
        │   ├── PythonProjects/
        │   │   ├── ProjectA/
        │   │   │   └── main.py
        │   │   └── DataAnalysis/
        │   │       └── data.csv  <-- 当前文件
        │   └── ...
        └── Downloads/
```

## 文件访问模式 (File Access Modes)

无论是 Python 还是 C 语言，在打开文件时都需要指定**访问模式**。这些模式定义了文件的打开方式（读、写、追加）以及文件类型（文本、二进制）。

模式字符串通常由 **基础模式** (`r`, `w`, `a`, `x`) 加上可选的 **修饰符** (`b`, `t`, `+`) 组成。

### 基础模式字符

- `'r'`: 读取 (默认)
- `'w'`: 写入 (截断，即清空文件)
- `'x'`: 独占创建 (如果文件已存在则报错)
- `'a'`: 追加 (写入到文件末尾)
- `'b'`: 二进制模式
- `'t'`: 文本模式 (默认)
- `'+'`: 更新 (读写)

### 通用模式组合表

以下表格适用于 Python 的 `open()` 函数以及 C 语言的 `fopen()` 函数（注意：C 语言中没有 `'x'` 模式的标准直接对应，且 `'t'` 在 C 标准中通常省略，默认为文本模式）。

| 文本模式                 | 二进制模式       | 描述         | 指针位置 | 文件不存在时 | 文件存在时                                  |
| :----------------------- | :--------------- | :----------- | :------- | :----------- | :------------------------------------------ |
| `'r'`, `'rt'`            | `'rb'`           | **只读**     | 开头     | **报错**     | 正常读取                                    |
| `'r+'`, `'r+t'`, `'rt+'` | `'rb+'`, `'r+b'` | **读写**     | 开头     | **报错**     | 正常读写                                    |
| `'w'`, `'wt'`            | `'wb'`           | **只写**     | 开头     | 创建新文件   | **清空**内容                                |
| `'w+'`, `'w+t'`, `'wt+'` | `'wb+'`, `'w+b'` | **读写**     | 开头     | 创建新文件   | **清空**内容                                |
| `'a'`, `'at'`            | `'ab'`           | **追加**     | 结尾     | 创建新文件   | 追加到末尾                                  |
| `'a+'`, `'a+t'`, `'at+'` | `'ab+'`, `'a+b'` | **追加读写** | 结尾     | 创建新文件   | 追加到末尾 (读取时指针在开头，写入时在结尾) |
| `'x'`, `'xt'`            | `'xb'`           | **独占创建** | 开头     | 创建新文件   | **报错**                                    |
| `'x+'`, `'x+t'`, `'xt+'` | `'xb+'`, `'x+b'` | **独占读写** | 开头     | 创建新文件   | **报错**                                    |

{{< callout >}}

**注意** C 语言标准库通常不直接支持 `'x'` 模式，但在 C11 标准中引入了 `'x'` 作为 `fopen` 的扩展模式（如 `"wx"`）。Python 完全支持上述所有模式。

{{</ callout >}}

## Python 中的文件操作

Python 提供了内置函数 `open()` 来进行文件操作。

### 打开文件

语法：`file_object = open(file_name, access_mode)`

- `file_name`: 文件路径字符串。
- `access_mode`: 访问模式字符串（见上表）。默认为 `'r'`。

### 读取文件

- `read()`: 读取整个文件内容。
- `readline()`: 读取一行。
- `readlines()`: 读取所有行，返回一个列表。

### 写入与关闭

- `write(string)`: 将字符串写入文件。
- `close()`: 关闭文件，释放资源。**非常重要**。

### 代码示例

以下代码展示了基本的文件读取操作：

```python {filename="<程序：读取文件os.py>"}
f = open("./Task1.txt", "r")
fls = f.readlines()
for line in fls:
    line = line.strip()
    print(line)
f.close()
```

下面的示例展示了如何读取文件，处理数据，然后追加写入结果：

```python {filename="<程序：读取文件os.py，计算并写回>"}
f = open("./Task1.txt", "r+")
fls = f.readlines()
for line in fls:
    line = line.strip()
    lstr = line.split()
    if lstr[0] == "3":
        res = 0
        for e in lstr[1:]:
            res += int(e)
f.write("\n4 " + str(res))
f.close()
```

## C 语言中的文件操作

C 语言通过标准库 `<stdio.h>` 提供了一套丰富的文件处理函数。

### FILE 结构体与流 (Stream)

在 C 语言中，文件被抽象为**流 (Stream)**。`FILE` 是一个结构体类型，包含了管理流所需的所有信息（如文件描述符、缓冲区位置、错误指示器等）。我们通常使用指向 `FILE` 的指针（`FILE *`）也就是**文件指针**来操作文件。

### 打开与关闭

- **fopen**: 打开文件。
  - 原型：`FILE *fopen(const char *filename, const char *mode);`
  - 返回：成功返回文件指针，失败返回 `NULL`。
  - 模式：使用上文提到的**通用模式组合表**（如 `"r"`, `"w"`, `"a"`, `"rb"`, `"wb"` 等）。
- **fclose**: 关闭文件。
  - 原型：`int fclose(FILE *stream);`
  - 返回：成功返回 0，失败返回 `EOF`。

### 读写操作

#### 字符读写

- **fgetc**: 从流中读取一个字符。
  - `int fgetc(FILE *stream);`
- **fputc**: 写入一个字符到流。
  - `int fputc(int char, FILE *stream);`

#### 格式化读写 (文本文件)

- **fscanf**: 从文件中按照指定格式读取。
  - `int fscanf(FILE *stream, const char *format, ...);`
  - 示例：`fscanf(fp, "%d %s", &id, name);`
- **fprintf**: 按照指定格式写入文件。
  - `int fprintf(FILE *stream, const char *format, ...);`
  - 示例：`fprintf(fp, "ID: %d, Name: %s\\n", id, name);`

#### 二进制读写 (块读写)

- **fread**: 读取数据块。
  - `size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);`
  - 参数：目标缓冲区 `ptr`，每个元素大小 `size`，元素个数 `nmemb`。
- **fwrite**: 写入数据块。
  - `size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream);`

### 文件定位

- **rewind**: 将文件指针重置到文件开头。
  - `void rewind(FILE *stream);`
- **fseek**: 移动文件指针到指定位置。
  - `int fseek(FILE *stream, long int offset, int whence);`
  - `whence` 参数：
    - `SEEK_SET`: 文件开头
    - `SEEK_CUR`: 当前位置
    - `SEEK_END`: 文件结尾
- **ftell**: 获取当前文件指针的位置。
  - `long int ftell(FILE *stream);`
